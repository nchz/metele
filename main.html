<head>
  <style>
    * {
      box-sizing: border-box;
    }

    .column {
      float: left;
      padding: 5vw 5vw;
      height: 90vh;
    }

    .randw {
      width: 25%;
      background-color: #aaa;
    }

    .text {
      width: 75%;
      background-color: #bbb;
    }
  </style>
</head>

<body>
  <h2>Metele que son pastele</h2>
  <div>
    <input id="timeoutSeconds" type="number" value="10" style="width: 50px; text-align: right" /> segundos para pensar
    <button onclick="resetGame()" style="float: right;">Reiniciar</button>
  </div>
  <div class="column randw">
    <p id="randw" style="background: #fff" />
    <p id="prevw" />
  </div>
  <div class="column text">
    <textarea id="textinput" style="height: 75vh; width: 65vw;"></textarea>
  </div>
</body>

<script>
  // string handling module.
  function removePunctChars(str) {
    return str.replace(/[\.,;\-¡¿\?\!]/, "");
  }
  function removeAccents(str) {
    // return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    return str.replace("á", "a").replace("Á", "A")
      .replace("é", "e").replace("É", "E")
      .replace("í", "i").replace("Í", "I")
      .replace("ó", "o").replace("Ó", "O")
      .replace("ú", "u").replace("Ú", "U")
      .replace("ü", "u");
  }
  function normString(str) {
    var r = str.trim().toLowerCase();
    r = removePunctChars(r);
    r = removeAccents(r);
    return r
  }
  function isWord(str) {
    // check if `str` are just characters.
    var r = str.trim().toLowerCase();
    r = removeAccents(r);
    return [...r].map(c => "abcdefghijklmnopqrstuvwxyz".includes(c)).every(t => t);
  }
</script>
<script>
  // main module.
  var timerId;
  function buildTimer() {
    const seconds = Number(document.getElementById("timeoutSeconds").value);
    return setInterval(makeTextReadonly, 1000 * seconds);
  }
  function resetTimer() {
    clearInterval(timerId);
    timerId = buildTimer();
  }
  // functions for timeout.
  function deleteText() {
    document.getElementById("textinput").value = "";
  }
  function makeTextReadonly() {
    const textinput = document.getElementById("textinput");
    textinput.setAttribute("readonly", "true");
    textinput.setAttribute("style", "height: 75vh; width: 65vw; background: transparent;");
  }

  document.addEventListener("keydown", processWord);
  function processWord(e) {
    if (e.keyCode == 13 || e.keyCode == 32) {
      resetTimer();
      checkTargetWord();
    }
  }
  function checkTargetWord(e) {
    // check if target word was used.
    const inputWords = document.getElementById("textinput").value.trim().split(/\s+/);
    const lastWord = inputWords[inputWords.length - 1];
    const targetWord = document.getElementById("randw").innerHTML;
    if (normString(lastWord) === normString(targetWord)) {
      document.getElementById("randw").innerHTML = getRandomWord();
      const prevw = document.getElementById("prevw")
      prevw.innerHTML = targetWord + "<br>" + prevw.innerHTML;
    }
  }

  var words;
  const url = "https://raw.githubusercontent.com/mazyvan/most-common-spanish-words/master/most-common-spanish-words-v4.txt";
  function getWordList() {
    var r = new XMLHttpRequest();
    r.open("GET", url, false);
    r.onreadystatechange = function () {
      if (r.readyState === 4) {
        if (r.status === 200 || r.status == 0) {
          const text = r.responseText;
          words = text.split("\n").map(w => removePunctChars(w.trim())).filter(w => w.length > 3 && isWord(w));
          console.log(`Using ${words.length} words.`)
        }
      }
    }
    r.send(null);
  }
  getWordList();
  function getRandomWord() {
    const i = Math.floor(Math.random() * words.length);
    return words[i];
  }
  document.getElementById("randw").innerHTML = getRandomWord();

  function resetGame() {
    clearInterval(timerId);
    const textinput = document.getElementById("textinput");
    textinput.removeAttribute("readonly");
    textinput.setAttribute("style", "height: 75vh; width: 65vw;");
  }
</script>