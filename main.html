<!DOCTYPE html>
<html>

<head>
  <title>Metele</title>
  <style>
    * {
      box-sizing: border-box;
    }

    .logo {
      float: left;
      height: 100%;
    }

    .header {
      position: fixed;
      left: 0;
      width: 100vw;
      padding: 15px 15px;
      top: 0;
      height: 15vh;
      background: lemonchiffon;
    }

    .footer {
      position: fixed;
      left: 0;
      width: 100vw;
      padding: 15px 15px;
      bottom: 0;
      height: 5vh;
      background: lemonchiffon;
    }

    .main {
      position: fixed;
      left: 0;
      width: 100vw;
      top: 15vh;
      height: 80vh;
    }

    .column {
      float: left;
      padding: 5% 5%;
      height: 100%;
    }

    .story-text {
      width: 70%;
      background: lightgoldenrodyellow;
    }

    textarea {
      height: 100%;
      width: 100%;
    }

    .random-words {
      width: 30%;
      background: lightyellow;
    }

    .target-word {
      background: white;
      text-align: center;
      line-height: 2;
    }

    .prev-words-grid {
      display: grid;
      grid-template-columns: 60% 40%;
    }

    .square {
      width: 100%;
      height: 0;
      padding-top: 100%;
      position: relative;
    }

    .square-content {
      position: absolute;
      top: 0;
      left: 0;
    }

    @media screen and (max-width: 1100px) {
      .prev-words-grid {
        grid-template-columns: 100%;
      }
    }

    @media screen and (max-width: 650px) {
      .column {
        width: 100%;
      }

      .story-text {
        height: 80%;
      }

      .random-words {
        height: 20%;
      }

      .target-word {
        float: left;
        width: 30%;
      }

      .prev-words-grid {
        float: right;
        width: 65%;
        grid-template-columns: 50% 50%;
        max-height: 100%;
        overflow: hidden;
      }
    }
  </style>
</head>

<body>
  <div class="footer">v0.5.2</div>
  <div class="header">
    <img src="logo.png" class="logo" />
    <div style="float: right;">
      <p>
        <input id="timeoutSeconds" type="number" value="10" style="width: 50px;" /> segundos para pensar
      </p>
      <button onclick="resetGame()">Reiniciar</button>
      <button onclick="downloadStory()">Descargar</button>
    </div>
  </div>
  <div class="main">
    <div class="column random-words">
      <div class="square">
        <img id="randomImage" class="square-content" width="100%">
      </div>
      <div id="targetWord" class="target-word"></div>
      <div id="prevWords" class="prev-words-grid">
      </div>
    </div>
    <div class="column story-text">
      <textarea id="storyText"></textarea>
    </div>
  </div>
</body>

<script>
  // string handling module.
  function removePunctChars(str) {
    return str.replace(/[\.,;\-¡¿\?\!]/g, "");
  }
  function removeAccents(str) {
    // return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    return str.replace(/á/g, "a").replace(/Á/g, "A")
      .replace(/é/g, "e").replace(/É/g, "E")
      .replace(/í/g, "i").replace(/Í/g, "I")
      .replace(/ó/g, "o").replace(/Ó/g, "O")
      .replace(/ú/g, "u").replace(/Ú/g, "U")
      .replace(/ü/g, "u");
  }
  function normString(str) {
    var r = str.trim().toLowerCase();
    r = removePunctChars(r);
    r = removeAccents(r);
    return r
  }
  function isWord(str) {
    // check if `str` are just characters.
    var r = str.trim().toLowerCase();
    r = removeAccents(r);
    return [...r].map(c => "abcdefghijklmnopqrstuvwxyz".includes(c)).every(t => t);
  }
</script>
<script>
  // main module.
  var timerId;
  function buildTimer() {
    const seconds = Number(document.getElementById("timeoutSeconds").value);
    return setInterval(endGame, 1000 * seconds);
  }
  function resetTimer() {
    clearInterval(timerId);
    timerId = buildTimer();
  }
  function endGame() {
    clearInterval(timerId);
    const storyText = document.getElementById("storyText");
    storyText.setAttribute("readonly", "true");
    storyText.setAttribute("style", "background: transparent;");
    // count words.
    const inputWords = storyText.value.trim().split(/\s+/);
    const msg = `
      Se acabo el tiempo!

      ${inputWords.length} palabras escritas.
      ${storyText.value.trim().length} caracteres escritos.
    `;
    alert(msg);
  }

  document.getElementById("storyText").addEventListener("keydown", processWord);
  function processWord(e) {
    if (e.keyCode == 13 || e.keyCode == 32) {
      resetTimer();
      checkTargetWord();
    }
  }
  function checkTargetWord(e) {
    // check if target word was used.
    const inputWords = document.getElementById("storyText").value.trim().split(/\s+/);
    const lastWord = inputWords[inputWords.length - 1];
    const targetWord = document.getElementById("targetWord").innerHTML;
    if (targetWord === ". . .") {
      document.getElementById("targetWord").innerHTML = getRandomWord();
    } else if (normString(lastWord) === normString(targetWord)) {
      document.getElementById("targetWord").innerHTML = getRandomWord();
      const prevWords = document.getElementById("prevWords")
      prevWords.innerHTML = "<div>" + targetWord + "</div>" + prevWords.innerHTML;
      document.getElementById("randomImage").setAttribute("src", getRandomImage());
    }
  }

  var randomImageList;
  const urlImages = "https://gist.githubusercontent.com/nchz/3fd8b2a8174c00891e61f28e392865f4/raw/a9638c0271a59578ba7d89d0ff09cabb49fdc2bb/gistfile1.txt";
  function getImageList() {
    var r = new XMLHttpRequest();
    r.open("GET", urlImages, true);
    r.onreadystatechange = function () {
      if (r.readyState === 4) {
        if (r.status === 200 || r.status == 0) {
          const text = r.responseText;
          randomImageList = text.split("\n");
          console.log(`Using ${randomImageList.length} images.`)
        }
      }
    }
    r.send(null);
  }
  getImageList();
  function getRandomImage() {
    if (randomImageList) {
      const i = Math.floor(Math.random() * randomImageList.length);
      return randomImageList[i];
    } else {
      return "";
    }
  }

  var randomWordList;
  const urlWords = "https://raw.githubusercontent.com/mazyvan/most-common-spanish-words/master/most-common-spanish-words-v4.txt";
  function getWordList() {
    var r = new XMLHttpRequest();
    r.open("GET", urlWords, true);
    r.onreadystatechange = function () {
      if (r.readyState === 4) {
        if (r.status === 200 || r.status == 0) {
          const text = r.responseText;
          randomWordList = text.split("\n").map(w => removePunctChars(w.trim())).filter(w => w.length > 3 && isWord(w));
          console.log(`Using ${randomWordList.length} words.`)
        }
      }
    }
    r.send(null);
  }
  getWordList();
  function getRandomWord() {
    if (randomWordList) {
      const i = Math.floor(Math.random() * randomWordList.length);
      return randomWordList[i];
    } else {
      return ". . .";
    }
  }
  document.getElementById("targetWord").innerHTML = getRandomWord();

  function resetGame() {
    clearInterval(timerId);
    // reset text.
    const storyText = document.getElementById("storyText");
    storyText.value = "";
    storyText.removeAttribute("readonly");
    storyText.removeAttribute("style");
    // reset random words.
    document.getElementById("targetWord").innerHTML = ". . .";
    document.getElementById("prevWords").innerHTML = "";
    document.getElementById("randomImage").removeAttribute("src");
  }

  function downloadStory() {
    const storyText = document.getElementById("storyText").value;
    const now = new Date();
    const downloadLink = document.createElement("a");
    downloadLink.href = "data:x-application/text," + escape(storyText);
    downloadLink.download = `${now.toISOString().slice(0, -5)}.txt`;
    downloadLink.click();
    downloadLink.remove();
  }
</script>

</html>